<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" type="text/css" href="./style.css">
    <title>Document</title>
</head>

<body>
    <div id="app">
        <heads></heads>
        <maincontainer></maincontainer>
        <newpost v-if="visble"></newpost>
    </div>

    <script src="https://unpkg.com/vue@3"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.6/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.6/firebase-analytics.js";
        import { getDatabase, ref, set, onValue, push, child, get } from "https://www.gstatic.com/firebasejs/9.6.6/firebase-database.js"
        import { getStorage, uploadBytes, ref as Sref, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.6/firebase-storage.js"

        const firebaseConfig = {
            apiKey: "AIzaSyCy5lslr5DMKgPjsHvlFR1BxgFrfyzfLJw",
            authDomain: "test-2ae8c.firebaseapp.com",
            databaseURL: "https://test-2ae8c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "test-2ae8c",
            storageBucket: "test-2ae8c.appspot.com",
            messagingSenderId: "489171593882",
            appId: "1:489171593882:web:ffd782e5c51a41358c4d23",
            measurementId: "G-Q2GB1118T0"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const storage = getStorage(app);

        const rdb = getDatabase(app);
        const starCountRef = ref(rdb, 'postimg');

        // function datacall(){
        //     get(starCountRef).then((result) => {
        //         console.log(result.val());
        //     })
        // };
        // datacall()

        function _uuid() {
            var d = Date.now();
            if (typeof performance !== 'undefined' && typeof performance.now === 'function') {
                d += performance.now(); //use high-precision timer if available
            }
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = (d + Math.random() * 16) % 16 | 0;
                d = Math.floor(d / 16);
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }

        const vapp = Vue.createApp({
            data() {
                return {
                    visble: false,
                    vh: true,

                }
            },
            methods: {
                visblechange() {
                    this.visble = !this.visble;
                    if (this.visble) {
                        document.body.style['overflow-y'] = 'hidden';
                    } else {
                        document.body.style['overflow-y'] = 'auto';
                    }
                }
            },
        })


        vapp.component('heads', {
            data() {
                return {

                }
            },
            template: `
            <header>
                <nav>
                    <headbuttons></headbuttons>
                    <headserch></headserch>
                    <headdesktop></headdesktop>
                </nav>
            </header>
            `
        })

        vapp.component('headbuttons', {
            data() {
                return {

                }
            },
            template: `
            <div class='headbuttons'>
                <a class="headerhome">
                    <img src="https://www.instagram.com/static/images/web/mobile_nav_type_logo.png/735145cfe0a4.png" alt="">
                </a>
            </div>
            `
        })

        vapp.component('headserch', {
            data() {
                return {

                }
            },
            template: `
                <div class='headserch'>
                    <i class="bi bi-search"></i>
                    <input type="text" placeholder="Search">
                </div>
            `
        })

        vapp.component('headdesktop', {
            data() {
                return {

                }
            },
            template: `
            <div class='headbuttons'>
                <awithsvg href='' svg='bi bi-house-door' styles='font-size: 1.5rem; font-weight: 500; color: #000;' ></awithsvg>
                <awithsvg href='' @click="$root.visblechange()" svg='bi bi-plus-square' styles='font-size: 1.5rem; font-weight: 500; color: #000;'></awithsvg>
                <awithsvg href='' svg='bi bi-heart' styles='font-size: 1.5rem; font-weight: 500; color: #000;' ></awithsvg>
            </div>
                `
        })

        // app.component('headmobile', {
        //     data() {
        //         return {

        //         }
        //     },
        //     template: `
        //     <div class='header__buttons'>
        //         <awithsvg href='' svg='' styles='' ></awithsvg>
        //         <awithsvg href='' svg='' styles='' ></awithsvg>
        //         <awithsvg href='' svg='' styles='' ></awithsvg>
        //     </div>
        //     `
        // })

        vapp.component('awithsvg', {
            data() {
                return {

                }
            },
            props: [
                'href', 'svg', 'styles'
            ],
            computed: {
                hrefs() {
                    if (typeof (this.href) == "undefined") {
                        return '#';
                    } else {
                        return '#' + this.href;
                    }
                }
            },
            template: `
            <a :href=hrefs>
                <i :class=svg :style=styles ></i>
            </a>
            `
        })

        vapp.component('maincontainer', {
            data() {
                return {
                    datalist:''
                }
            },
            mounted(){
                    this.datacall()
            },
            methods: {
                datacall() {
                    get(starCountRef).then((result) => {
                        console.log('nuiwdc')
                        this.datalist=Object.values(result.val()).reverse();
                        console.log(result.val());
                    })
                }
            },
            template: `
            <main>
                <section>
                    <div class='posts'>
                        <article v-for="(i,j,k) in datalist" class='post'>
                            <posthead :name=i.username></posthead>
                            <postcont :src=i.img></postcont>
                            <postfoot :name=i.username :para=i.para :time=i.time></postfoot>
                        </article>
                    </div>
                </section>
            </main>
            `
        })

        vapp.component('posthead', {
            data() {
                return {

                }
            },
            props:['name'],
            template: `
            <div class='posthead'>
                <div class="post__profile">
                    <a href="#" class="post__avatar">
                        <img src="./img/default-user.png" />
                    </a>
                    <a href="#" class="post__user">{{name}}</a>
                </div>
                <button class="post__more-options">
                    <i class="bi bi-three-dots"></i>
                </button>
            </div>
            `
        })

        vapp.component('postcont', {
            data() {
                return {

                }
            },
            props:['src'],
            template: `
            <div class='postcont'>
                <div class="post__medias">
                    <img class="post__media" :src="src" alt="Post Content" />
                </div>
            </div>
            `,
        })

        vapp.component('postfoot', {
            data() {
                return {

                }
            },
            props:['name', 'para', 'time'],
            computed:{
                timeago:{
                    get(){
                        if (Math.floor((Date.now()-this.time)/1000)<60) {
                            return String(Math.floor((Date.now()-this.time)/1000)+' 秒前');
                        } else {
                            return String(Math.floor((Date.now()-this.time)/1000/60)+' 分鐘前');
                        }
                    }
                }
            },
            template: `
            <div class='postfoot'>
                <div class="post__buttons">
                    <button class="post__button">
                        <i class="bi bi-heart"></i>
                    </button>
                
                    <div class="post__indicators"></div>
                
                    <button class="post__button">
                        <i class="bi bi-chat"></i>
                    </button>
                    <button class="post__button">
                        <i class="bi bi-share"></i>
                    </button>
                </div>

                <div class="post__infos">
                    <div class="post__description">
                        <span>
                            <a class="post__name--underline" href="#">{{name}}</a>
                            {{para}}
                        </span>
                    </div>
                
                    <span class="post__date-time">{{timeago}}</span>
                </div>
            </div>
            `
        })

        vapp.component("newpost", {
            data() {
                return {
                    imgshow: true,
                    postpara: '',
                    src: '',
                    file: ''
                }
            },
            methods: {
                handleFileUpload() {
                    uploadBytes(Sref(storage, 'postimg/' + _uuid()), this.file).then((snapshot) => {
                        getDownloadURL(snapshot.ref).then((url) => {
                            set(push(starCountRef), {
                                username: 'none',
                                userimg: 'none',
                                img: url,
                                para: this.postpara,
                                time: Date.now()
                            });
                            this.postpara = ''
                            this.src = ''
                            this.file = ''
                        });
                    });

                    this.$root.visblechange()
                },
                fileSelected(event) {
                    this.file = event.target.files.item(0); //取得File物件
                    const reader = new FileReader(); //建立FileReader 監聽 Load 事件
                    reader.addEventListener('load', this.imageLoader);
                    reader.readAsDataURL(this.file);
                },
                imageLoader(event) {
                    this.src = event.target.result;
                    this.imgshow = false;
                }
            },
            template: `
            <div class="fliter">
                <div class="close">
                    <button class="close-button" @click="$root.visblechange()">
                        <i class="bi bi-x-lg" style="color: #fff;"></i>
                    </button>
                </div>
                <div class="newpost">
                    <div class="newpost_form">
                        <div class="newpost_head">
                            <div></div>
                            <p>新增貼文</p>
                            <div></div>
                        </div>
                        <div class="newpost_conten">
                            <div class="newpost_img" v-if="$root.vh">
                                <div class="someth" v-if='imgshow'>
                                   <i class="bi bi-upload"></i>
                                   <p>把相片拖到這裡</p>
                                   <button class="btn btn-info" @click="$refs.file.click()">從電腦選擇相片</button>
                                   <input style="display:none" ref="file" type="file" @change="fileSelected">
                                </div>
                                <img v-else :src='src' alt="">
                            </div>
                            <div class="newpost_para">
                                <textarea v-model='postpara' name="" id="" cols="30" rows="10" placeholder="撰寫貼文"></textarea>
                            </div>
                        </div>
                        <div class="newpost_footer">
                            <button @click='handleFileUpload()'>上傳</button>
                        </div>
                    </div>
                </div>
            </div>
            `
        })

        vapp.mount('#app')

    </script>
</body>

</html>

<!-- 
<div class="post__likes">
    <a href="#" class="post__likes-avatar">
        <img src="../instagram-clone/assets/default-user.png" alt="User Picture" />
    </a>

    <span>Liked by
        <a class="post__name--underline" href="#">user123</a> and
        <a href="#">73 others</a></span>
</div>
 -->